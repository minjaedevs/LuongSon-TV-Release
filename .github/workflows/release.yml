name: Create Release on Push to Main

on:
  push:
    branches:
      - main

permissions:
  contents: write
  packages: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from release config
        id: version
        run: |
          if [ -f .release-config.json ]; then
            VERSION=$(jq -r '.name // "Release v1.0.0"' .release-config.json | grep -oP 'v\K[0-9.]+' || echo "1.0.0")
            echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          else
            VERSION="1.0.0"
            echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Get release config
        id: config
        run: |
          if [ -f .release-config.json ]; then
            NAME=$(jq -r '.name // "Release"' .release-config.json)
            DESCRIPTION=$(jq -r '.description // ""' .release-config.json)
            DRAFT=$(jq -r '.draft // false' .release-config.json)
            PRERELEASE=$(jq -r '.prerelease // false' .release-config.json)
          else
            NAME="Release v${{ steps.version.outputs.VERSION }}"
            DESCRIPTION="Automatic release from main branch"
            DRAFT="false"
            PRERELEASE="false"
          fi
          echo "NAME=$NAME" >> $GITHUB_OUTPUT
          echo "DESCRIPTION=$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "DRAFT=$DRAFT" >> $GITHUB_OUTPUT
          echo "PRERELEASE=$PRERELEASE" >> $GITHUB_OUTPUT

      - name: Find APK asset
        id: find_apk
        run: |
          APK_FILE=$(find ./releases -name "*.apk" -type f 2>/dev/null | head -1)
          if [ -n "$APK_FILE" ]; then
            echo "APK_PATH=$APK_FILE" >> $GITHUB_OUTPUT
            echo "Found APK: $APK_FILE"
          else
            echo "No APK file found in releases/"
            echo "APK_PATH=" >> $GITHUB_OUTPUT
          fi

      - name: Create Release with APK
        uses: softprops/action-gh-release@v1
        if: steps.find_apk.outputs.APK_PATH != ''
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: ${{ steps.config.outputs.NAME }}
          body: ${{ steps.config.outputs.DESCRIPTION }}
          draft: ${{ steps.config.outputs.DRAFT }}
          prerelease: ${{ steps.config.outputs.PRERELEASE }}
          files: ${{ steps.find_apk.outputs.APK_PATH }}
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release without APK
        uses: softprops/action-gh-release@v1
        if: steps.find_apk.outputs.APK_PATH == ''
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: ${{ steps.config.outputs.NAME }}
          body: ${{ steps.config.outputs.DESCRIPTION }}
          draft: ${{ steps.config.outputs.DRAFT }}
          prerelease: ${{ steps.config.outputs.PRERELEASE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
