name: Create Release on Push to Main

on:
  push:
    branches:
      - main

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from build.gradle
        id: version
        run: |
          if [ -f "app/build.gradle" ] || [ -f "app/build.gradle.kts" ]; then
            # Try to extract versionName from build.gradle
            VERSION=$(grep -oP 'versionName\s*=\s*"\K[^"]+' app/build.gradle* || echo "1.0.0")
            echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          else
            VERSION="1.0.0"
            echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Get release config
        id: config
        run: |
          if [ -f .release-config.json ]; then
            NAME=$(jq -r '.name // "Release"' .release-config.json)
            DESCRIPTION=$(jq -r '.description // ""' .release-config.json)
            DRAFT=$(jq -r '.draft // false' .release-config.json)
            PRERELEASE=$(jq -r '.prerelease // false' .release-config.json)
          else
            NAME="Release v${{ steps.version.outputs.VERSION }}"
            DESCRIPTION="Automatic release from main branch"
            DRAFT="false"
            PRERELEASE="false"
          fi
          echo "NAME=$NAME" >> $GITHUB_OUTPUT
          echo "DESCRIPTION=$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "DRAFT=$DRAFT" >> $GITHUB_OUTPUT
          echo "PRERELEASE=$PRERELEASE" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}-${{ github.run_number }}
          release_name: ${{ steps.config.outputs.NAME }}
          body: ${{ steps.config.outputs.DESCRIPTION }}
          draft: ${{ steps.config.outputs.DRAFT }}
          prerelease: ${{ steps.config.outputs.PRERELEASE }}

      - name: Find and upload APK asset
        id: find_apk
        run: |
          # Tìm APK trong thư mục releases
          APK_FILE=$(find ./releases -name "*.apk" -type f 2>/dev/null | head -1)
          if [ -n "$APK_FILE" ]; then
            echo "APK_PATH=$APK_FILE" >> $GITHUB_OUTPUT
            echo "Found APK: $APK_FILE"
          else
            echo "No APK file found in releases/"
            echo "APK_PATH=" >> $GITHUB_OUTPUT
          fi

      - name: Upload APK asset
        if: steps.find_apk.outputs.APK_PATH != ''
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.find_apk.outputs.APK_PATH }}
          asset_name: sports-tv-v${{ steps.version.outputs.VERSION }}.apk
          asset_content_type: application/vnd.android.package-archive
